<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>NJ COVID Twitter Bot!</title>

    <!-- Bootstrap core CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />

    <script
      src="https://code.jquery.com/jquery-1.12.4.min.js"
      integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
    <script type="text/javascript" src="popperjs/popper.min.js"></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"
    ></script>

    <link
      rel="stylesheet"
      href="jQuery-Multiple-Select-Plugin-For-Bootstrap-Bootstrap-Multiselect/dist/css/bootstrap-multiselect.min.css"
      type="text/css"
    />
    <script
      type="text/javascript"
      src="jQuery-Multiple-Select-Plugin-For-Bootstrap-Bootstrap-Multiselect/dist/js/bootstrap-multiselect.min.js"
    ></script>

    <!-- Custom styles for this template -->
    <!-- <link href="<%= static_path + "/bootstrap/css/jumbotron-narrow.css" %>" rel="stylesheet"> -->
  </head>

  <body>
    <div class="container">
      <div class="header">
        <ul class="nav nav-pills pull-right">
          <li><a href="#">Register</a></li>
          <li><a data-toggle="modal" href="#loginModal">Login</a></li>
          <li>
            <a id="account" data-toggle="modal" href="#accountModal">Account</a>
          </li>
        </ul>
        <h3 class="text-muted">NJ COVID Twitter Bot</h3>
      </div>
      <% if (flask_debug === 'true') { %>
      <div class="alert alert-danger">
        Flask is in debug mode. This is not safe for production.
      </div>
      <% } %>
      <div id="signupSuccess" class="alert alert-success" style="display: none">
        <p id="signupSuccessText">
          Thanks for signing up! You'll be among the first to know when we
          launch.
        </p>
      </div>
      <div
        id="signupDuplicate"
        class="alert alert-success"
        style="display: none"
      >
        <p id="signupDuplicateText">
          Fear not, you're already on the list! You'll be among the first to
          know when we launch.
        </p>
      </div>
      <div id="signupError" class="alert alert-info" style="display: none">
        <p id="signupErrorText">
          Well this is embarrassing. It looks like we're having trouble getting
          you on the list.
        </p>
      </div>
      <div class="jumbotron">
        <h1>The next big thing is coming...</h1>
        <p class="lead">
          We're pretty thrilled to unveil our latest creation. Sign up below to
          be notified when we officially launch!
        </p>
        <p>
          <a
            class="btn btn-lg btn-success"
            data-toggle="modal"
            href="#signupModal"
            >Sign up today</a
          >
        </p>
      </div>

      <div class="footer">
        <p>&copy; NJ COVID Twitter Bot</p>
      </div>

      <!-- Modal -->
      <div
        class="modal fade"
        id="signupModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="signupModal"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-hidden="true"
              >
                &times;
              </button>
              <h4 class="modal-title">
                Register here to be notified about COVID updates.
              </h4>
            </div>
            <div class="modal-body">
              <form id="signupForm" role="form">
                <input
                  type="hidden"
                  id="theme"
                  name="theme"
                  value="<%= theme %>"
                />
                <div class="form-group">
                  <label for="email">Email address</label>
                  <input
                    type="email"
                    class="form-control"
                    id="signup-email"
                    name="email"
                    placeholder="Your email address"
                  />
                </div>
                <div class="form-group">
                  <label for="email">Email Alerts Enabled?</label>
                  <input
                    type="checkbox"
                    class="form-control"
                    id="signup-email-enabled"
                    name="emailEnabled"
                  />
                </div>
                <div class="form-group">
                  <label for="phone">Mobile phone</label>
                  <input
                    type="phone"
                    class="form-control"
                    id="signup-phone"
                    name="phone"
                    placeholder="Your phone number"
                  />
                </div>
                <div class="form-group">
                  <label for="email">Phone Alerts Enabled?</label>
                  <input
                    type="checkbox"
                    class="form-control"
                    id="signup-phone-enabled"
                    name="phoneEnabled"
                  />
                </div>
                <div class="form-group">
                  <label for="password">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="signup-password"
                    name="password"
                    placeholder="Your password"
                  />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button id="signup" type="button" class="btn btn-primary">
                Sign Up!
              </button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->

      <div
        class="modal fade"
        id="accountModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="accountModal"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-hidden="true"
              >
                &times;
              </button>
              <h4 class="modal-title">Update your account data here</h4>
            </div>
            <div class="modal-body">
              <form id="accountForm" role="form">
                <div class="form-group">
                  <label for="email">Email address</label>
                  <input
                    type="email"
                    class="form-control"
                    id="account-email"
                    name="email"
                    placeholder="Your email address"
                    readonly="readonly"
                  />
                </div>
                <div class="form-group">
                  <label for="email">Email Alerts Enabled?</label>
                  <input
                    type="checkbox"
                    class="form-control"
                    id="account-email-enabled"
                    name="emailEnabled"
                  />
                </div>
                <div class="form-group">
                  <label for="password">Phone Number</label>
                  <input
                    type="phone"
                    class="form-control"
                    id="account-phone"
                    name="phone"
                    placeholder="Your phone number"
                  />
                </div>
                <div class="form-group">
                  <label for="email">Phone Alerts Enabled?</label>
                  <input
                    type="checkbox"
                    class="form-control"
                    id="account-phone-enabled"
                    name="phoneEnabled"
                  />
                </div>
                <select id="account-filters" multiple="multiple">
                  <option value="All">All</option>
                  <option value="Atlantic">Atlantic</option>
                  <option value="Bergen">Bergen</option>
                  <option value="Burlington">Burlington</option>
                  <option value="Camden">Camden</option>
                  <option value="Cape May">Cape May</option>
                  <option value="Cumberland">Cumberland</option>
                  <option value="Essex">Essex</option>
                  <option value="Gloucester">Gloucester</option>
                  <option value="Hudson">Hudson</option>
                  <option value="Hunterdon">Hunterdon</option>
                  <option value="Mercer">Mercer</option>
                  <option value="Middlesex">Middlesex</option>
                  <option value="Monmouth">Monmouth</option>
                  <option value="Morris">Morris</option>
                  <option value="Ocean">Ocean</option>
                  <option value="Passaic">Passaic</option>
                  <option value="Salem">Salem</option>
                  <option value="Somerset">Somerset</option>
                  <option value="Sussex">Sussex</option>
                  <option value="Union">Union</option>
                  <option value="Warren">Warren</option>
                </select>
              </form>
            </div>
            <div class="modal-footer">
              <div
                id="accountUpdateSuccess"
                class="alert alert-info"
                style="display: none"
              >
                <p id="accountUpdateSuccessText">
                  Account data successfully updated
                </p>
              </div>
              <button id="account-update" type="button" class="btn btn-primary">
                Update
              </button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>

      <div
        class="modal fade"
        id="loginModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="loginModal"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-hidden="true"
              >
                &times;
              </button>
              <h4 class="modal-title">
                Please login to your account. Or register for a new account.
              </h4>
            </div>
            <div class="modal-body">
              <div
                id="loginError"
                class="alert alert-info"
                style="display: none"
              >
                <p id="loginErrorText">
                  We could not log you in to your account
                </p>
              </div>
              <form id="loginForm" role="form">
                <div class="form-group">
                  <label for="email">Email address</label>
                  <input
                    type="email"
                    class="form-control"
                    id="login-email"
                    name="email"
                    placeholder="Your email address"
                  />
                </div>
                <div class="form-group">
                  <label for="password">Password</label>
                  <input
                    type="password"
                    class="form-control"
                    id="login-password"
                    name="password"
                    placeholder="Your password"
                  />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button id="login" type="button" class="btn btn-primary">
                Login
              </button>
              <button id="loginToSignup" type="button" class="btn btn-info">
                Signup
              </button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
    </div>
    <!-- /container -->

    <script type="text/javascript">
      $(document).ready(function () {
        /* var userPoolId = null;
        var clientId = null;
        var region = null;
        var identityPoolId = null;
 */
        var idToken = null;
        var accessToken = null;
        var refreshToken = null;

        function initApp() {
          /* $.get("/config", {}, function (data) {
            console.log("AWS credentials: ", data);
            if (
              !data.userPoolId ||
              !data.clientId ||
              !data.region ||
              !data.identityPoolId
            ) {
              console.error("Could not fetch AWS configuration");
              return;
            }
            userPoolId = data.userPoolId;
            clientId = data.clientId;
            region = data.region;
            identityPoolId = data.identityPoolId;
          }); */

          idToken = Cookies.get("idToken");
          accessToken = Cookies.get("accessToken");
          refreshToken = Cookies.get("refreshToken");

          if (!idToken || !accessToken || !refreshToken) {
            $("#loginModal").modal("show");
          }
          //https://www.jqueryscript.net/form/jQuery-Multiple-Select-Plugin-For-Bootstrap-Bootstrap-Multiselect.html
          $("#account-filters").multiselect({});
        }

        initApp();

        $("#loginToSignup").click(function () {
          $("#loginModal").modal("hide");
          $("#signupModal").modal("show");
        });

        $("#signup").click(function () {
          $.post("/signup", $("#signupForm").serialize(), function (data) {
            $("#signupSuccess").show();
          })
            .error(function (xhr) {
              switch (xhr.status) {
                case 409:
                  $("#signupDuplicate").show();
                  break;
                default:
                  $("#signupError").show();
              }
            })
            .always(function () {
              $("#signupModal").modal("hide");
            });
        });
        $("#login").click(function () {
          $.post("/login", $("#loginForm").serialize(), function (data) {
            console.log("account data: ", data);
            if (data.idToken && data.accessToken && data.refreshToken) {
              Cookies.set("accessToken", data.accessToken);
              Cookies.set("refreshToken", data.refreshToken);
              Cookies.set("idToken", data.idToken);
              $("#loginModal").modal("hide");
            }
          }).error(function (xhr) {
            switch (xhr.status) {
              case 401:
                break;
                $("#loginError").show();
              default:
                $("#loginError").show();
            }
          });
        }),
          "json";

        $("#account-update").click(function () {
          console.log($("#accountForm").serialize());
          var data = $("#accountForm").serialize();
          data +=
            "&filters=" +
            encodeURIComponent(JSON.stringify($("#account-filters").val()));
          data += "&idToken=" + encodeURIComponent(Cookies.get("idToken"));
          console.log(data);
          $.post("/account-update", data, function (data) {
            if (data && data.success) {
              $("#accountUpdateSuccess").show();
            }
          });
        });

        $("#account").click(function () {
          console.log("get acct");
          var acctIdToken = Cookies.get("idToken");
          if (!acctIdToken) {
            console.error("User is not authenticated");
            return;
          }
          $.post(
            "/account",
            {
              idToken: acctIdToken,
            },
            function (data) {
              console.log("account data: ", data);
              if (data) {
                if (data.email) {
                  $("#account-email").val(data.email);
                }
                if (data.emailEnabled) {
                  $("#account-email-enabled").prop(
                    "checked",
                    data.emailEnabled
                  );
                }
                if (data.phone) {
                  $("#account-phone").val(data.phone);
                }
                if (data.phoneEnabled) {
                  $("#account-phone-enabled").prop(
                    "checked",
                    data.phoneEnabled
                  );
                }
                if (data.filters) {
                  data.filters.forEach((filter) => {
                    $("#account-filters").multiselect("select", filter);
                  });
                }
                $("#accountModal").show();
              }
            }
          ).error(function (xhr) {
            switch (xhr.status) {
              case 409:
                break;
              default:
                $("#accountError").show();
            }
          });
        }),
          "json";
      });
    </script>
  </body>
</html>
